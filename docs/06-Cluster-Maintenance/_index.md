# Cluster Maintenance

## OS Upgrades

### Pod Eviction Timeout

- 파드가 다운되었을 때, Kubelet은 파드를 다시 활성 상태로 만든다.
- 하지만 파드가 5분 이상 다운 상태가 되면 쿠버네티스는 그 파드가 죽은 것으로 간주하여 해당 파드는 노드로부터 종료된다.
- 만약 파드가 레플리카셋의 일부인 경우에는 다른 노드에서 재생성된다.
- 파드가 다시 온라인 상태가 될 때까지 기다리는 시간을 파드 제거 시간 초과라고 하며, 아래 명령어를 통해 설정할 수 있다.
  ```bash
  kube-controller-manager --pod-eviction-timeout=5m0s
  ```
- 기본 설정은 5분으로, 마스터 노드는 파드가 죽은 것으로 간주하기 전에 최대 5분동안 기다리는 것이다.
- 파드 제거 시간 초과 이후 노드가 다시 활성화되면 예약된 파드 없이 빈 노드 상태로 활성화된다.

### Drain

- 안전하게 노드를 작업하기 위해, 드레인(drain)을 통해 모든 워크로드를 다른 노드로 옮길 수 있다. 이때 데몬셋을 제외하고 적용하려면 `--ignore-daemonsets` 옵션을 사용한다.
  ```bash
  kubectl drain node-1
  ```
- 기존 노드에서 파드가 종료되고, 다른 노드에서 재생성된다.
- 노드가 커든(cordon) 상태가 되거나 스케줄 불가능 상태가 된다. 이는 특별한 제한이 제거될 때까지 해당 노드에 스케줄된 파드가 없음을 의미한다.
- 파드가 다른 노드에서 정상적으로 구동되면, 노드를 재시동할 수 있다. 해당 노드가 다시 활성화되어도 여전히 스케줄 불가능 상태이다.
- 파드의 커든을 해제해야만 다시 파드가 스케줄된다.
  ```bash
  kubectl uncordon node-1
  ```
- 노드를 스케줄 불가능하게 하지만 드레인과 다르게 파드를 종료/이동시키지 않고 싶다면 커든을 적용한다. 이는 새로운 파드가 더 이상 스케줄링되지 않도록 처리한다.
  ```bash
  kubectl cordon node-1
  ```
